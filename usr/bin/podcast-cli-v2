#!/bin/bash

function _print_usage {
    # Print usage
    echo
    echo "Usage: $0 [options]"
    echo
    echo "Options:"
    echo "  -q | --quiet                        Nothing will be print to screen, except errors."
    echo ""
    echo ""
    echo "Help options:"
    echo "  -h | --help                         Print usage."
    echo "    --categories                      Print all show categories."
    echo "    --languages                       Print all show languages."
    echo ""
    echo ""
    echo "Show level options:"
    echo "  --show"
    echo "    --new"
    echo "    --edit"
    echo "    --delete"
    echo "    --list"
    echo "    --id                                Local identifier of the podcast/show. Decided by the user."
    echo "    --title                             Name of the podcast/show."
    echo "    --owner                             Email address of the owner."
    echo "    --author                            Text name(s) of the author(s) of this podcast.This need not be the same as the owner value."
    echo "    --explicit                          Indicates whether the podcast is explicit language or adult content. You can also tag individual episodes with this property for finer-grained control. Values set for this tag at the episode level override any value set at the show level."
    echo "    --url                               Fully-qualified URL of the homepage of your podcast"
    echo "    --picture                           Picture's URL to associate with your podcast/show."
    echo "    --category                          Code of the show category. For a list of all the available categories execute '$0 --help --categories'."
    echo "    --summary                           A plaintext description of the podcast/show."
    echo "    --language                          Code of the main language of the show. For a list of all the available languages execute '$0 --help --languages'."
    echo "    --show-id"
    echo "  How to:"
    echo "      Create a new show:"
    echo "          $0 --show --new --title '[your-title-here]' --owner '[your-owner-here]' --author '[your-author-here]' --url '[your-url-here]' --picture '[your-picture-here]' --category '[your-category-here]' --description '[your-description-here]' --language '[your-language-here]' --explicit 'false'"
    echo "      Create a new explicit show:"
    echo "          $0 --show --new --title '[your-title-here]' --owner '[your-owner-here]' --author '[your-author-here]' --url '[your-url-here]' --picture '[your-picture-here]' --category '[your-category-here]' --description '[your-description-here]' --language '[your-language-here]' --explicit 'true'"
    echo "      Delete a show:"
    echo "          $0 --show --delete --show-id '[your-show-id]'"
    echo "      List all shows:"
    echo "          $0 --show --list"
    echo "      Edit the title (or other tags) of an existing show:"
    echo "          $0 --show --edit --show-id '[your-show-id]' --title '[your-edited-title-here]'"
    echo ""
    echo ""
    echo "Episode level options:"
    echo "  --episode"
    echo "    --show-id                           Identifier of the show's episode."
    echo "    --new"
    echo "    --edit"
    echo "    --delete"
    echo "    --list"
    echo "    --id                                Local identifier of the episode. It is auto-generated."
    echo "    --title                             Title of the podcast episode."
    echo "    --summary                           A plaintext description of the episode."
    echo "    --explicit                          Indicates whether this episode contains explicit language or adult content. If absent, the episode inherits the show-level setting. If present, the value declared here overrides the show-level setting."
    echo "    --publication-datetime              Publication datetime of the episode. [YYYY-MM-DD HH:MM] [example: 2022-02-15 16:00]"
    echo "    --url                               Fully-qualified URL of the episode audio file."
    echo "    --episode-id"
    echo "  How to:"
    echo "      Create a new episode:"
    echo "          $0 --episode --show-id '[your-show-id]' --new --title '[your-title-here]' --description '[your-description-here]' --publication-datetime '[your-publication-datetime-here]' --url '[your-url-here]' --explicit 'false'"
    echo "      Create a new explicit episode:"
    echo "          $0 --episode --show-id '[your-show-id]' --new --title '[your-title-here]' --description '[your-description-here]' --publication-datetime '[your-publication-datetime-here]' --url '[your-url-here]' --explicit 'true'"
    echo "      Delete an episode:"
    echo "          $0 --episode --show-id '[your-show-id]' --delete --episode-id '[your-episode-id-here]'"
    echo "      List all episodes:"
    echo "          $0 --episode --show-id '[your-show-id]' --list"
    echo "      Edit the title (or other tags) of an existing episode:"
    echo "          $0 --episode --show-id '[your-show-id]' --edit --episode-id '[your-episode-id-here]' --title '[your-edited-title-here]'"
    echo ""
    echo ""
    echo "Backup options:"
    echo "  --backup"
    echo "      --show-id                           Identifier of the show."
    echo "      --new"
    echo "      --comment"
    echo "      --delete"
    echo "      --list                              Display a list of the created backups with IDs and comments."
    echo "      --restore                           Replace the actual database with the choosen backup."
    echo "      --backup-id"
    echo "  How to:"
    echo "      Create a backup:"
    echo "          $0 --backup --show-id '[your-show-id]' --new"
    echo "      Create a backup with a comment:"
    echo "          $0 --backup --show-id '[your-show-id]' --new --comment '[your-comment]'"
    echo "      Delete a backup:"
    echo "          $0 --backup --show-id '[your-show-id]' --delete --backup-id '[your-backup-id]'"
    echo "      List all backups:"
    echo "          $0 --backup --show-id '[your-show-id]' --list"
    echo "      Restore a backup:"
    echo "          $0 --backup --show-id '[your-show-id]' --restore --backup-id '[your-backup-id]'"
    echo ""
    echo ""
    echo "Feed options:"
    echo "  --feed"
    echo "      --show-id                           Identifier of the show."
    echo "      --format                            Format of export: RSS, Atom."
    echo "      --output                            Specify the path of the file you want to export to."
    echo "  How to:"
    echo "      Generate an RSS feed:"
    echo "          $0 --feed --show-id '[your-show-id]' --format 'RSS' --output '/your/path/to/file.xml'"
    echo "      Generate an Atom feed:"
    echo "          $0 --feed --show-id '[your-show-id]' --format 'Atom' --output '/your/path/to/file.xml'"
}

function _is_id_valid {
    id="${1}"

    #regex='^[[:lower:]_][[:lower:][:digit:]_-]{2,}$'
    regex='^[a-zA-Z0-9_.-]+$'

    if [[ ${id} =~ ${regex} ]]
    then 
        echo "true"
    else
        echo "false"
    fi
}

function _is_url_valid {
    url="${1}"

    regex='^(https?|ftp|file)://[-A-Za-z0-9\+&@#/%?=~_|!:,.;]*[-A-Za-z0-9\+&@#/%=~_|]\.[-A-Za-z0-9\+&@#/%?=~_|!:,.;]*[-A-Za-z0-9\+&@#/%=~_|]$'

    if [[ ${url} =~ ${regex} ]]
    then 
        echo "true"
    else
        echo "false"
    fi
}

function _is_email_address_valid {
    email_address="${1}"

    regex='^(([A-Za-z0-9]+((\.|\-|\_|\+)?[A-Za-z0-9]?)*[A-Za-z0-9]+)|[A-Za-z0-9]+)@(([A-Za-z0-9]+)+((\.|\-|\_)?([A-Za-z0-9]+)+)*)+\.([A-Za-z]{2,})+$'

    if [[ ${email_address} =~ ${regex} ]]
    then 
        echo "true"
    else
        echo "false"
    fi
}

PATH_LOCAL_STORAGE="/etc/podcast-cli"

# Execute getopt on the arguments passed to this program, identified by the special character $@
PARSED_OPTIONS=$(getopt -n "$0" -o h,q --long "help,quiet,languages,categories,show,episode,new,edit,delete,list,backup,restore,feed,id:,show-id:,title:,owner:,author:,explicit:,url:,image:,category:,description:,language:,publication-datetime:" -- "$@")

#Bad arguments, something has gone wrong with the getopt command.
if [ $? -ne 0 ];
then
    #_print_error "Bad arguments."
    echo "[ERROR] Something has gone wrong with the getopt command."
    exit 1
fi

# A little magic, necessary when using getopt.
eval set -- "${PARSED_OPTIONS}"

# Initialize array
declare -A OPTIONS_ARRAY
OPTIONS_ARRAY[quiet]='false'
OPTIONS_ARRAY[help]='false'
OPTIONS_ARRAY[categories]='false'
OPTIONS_ARRAY[languages]='false'

OPTIONS_ARRAY[show]='false'
OPTIONS_ARRAY[episode]='false'
OPTIONS_ARRAY[backup]='false'
OPTIONS_ARRAY[feed]='false'

OPTIONS_ARRAY[show-id]=''
OPTIONS_ARRAY[episode-id]=''
OPTIONS_ARRAY[backup-id]=''

OPTIONS_ARRAY[new]='false'
OPTIONS_ARRAY[edit]='false'
OPTIONS_ARRAY[delete]='false'
OPTIONS_ARRAY[list]='false'

OPTIONS_ARRAY[id]=''
OPTIONS_ARRAY[title]=''
OPTIONS_ARRAY[owner]=''
OPTIONS_ARRAY[author]=''
OPTIONS_ARRAY[explicit]='false'
OPTIONS_ARRAY[url]=''
OPTIONS_ARRAY[picture]=''
OPTIONS_ARRAY[category]=''
OPTIONS_ARRAY[summary]=''
OPTIONS_ARRAY[language]=''

OPTIONS_ARRAY[publication-datetime]=''

OPTIONS_ARRAY[comment]=''
OPTIONS_ARRAY[restore]='false'

OPTIONS_ARRAY[format]=''
OPTIONS_ARRAY[output]=''

# Now goes through all the options with a case and using shift to analyse 1 argument at a time.
#$1 identifies the first argument, and when we use shift we discard the first argument, so $2 becomes $1 and goes again through the case.
while true;
do
    case "${1}" in
        -q|--quiet)
            OPTIONS_ARRAY[quiet]='true'
            shift;;
        -h|--help)
            OPTIONS_ARRAY[help]='true'
            shift;;
        --categories)
            OPTIONS_ARRAY[categories]='true'
            shift;;
        --languages)
            OPTIONS_ARRAY[languages]='true'
            shift;;
        --show)
            OPTIONS_ARRAY[show]='true'
            shift;;
        --episode)
            OPTIONS_ARRAY[episode]='true'
            shift;;
        --backup)
            OPTIONS_ARRAY[backup]='true'
            shift;;
        --feed)
            OPTIONS_ARRAY[feed]='true'
            shift;;
        --new)
            OPTIONS_ARRAY[new]='true'
            shift;;
        --edit)
            OPTIONS_ARRAY[edit]='true'
            shift;;
        --delete)
            OPTIONS_ARRAY[delete]='true'
            shift;;
        --list)
            OPTIONS_ARRAY[list]='true'
            shift;;
        --restore)
            OPTIONS_ARRAY[restore]='true'
            shift;;
        --show-id)
            if [ -n "${2}" ]
            then
                OPTIONS_ARRAY[show-id]="${2}"
            fi
            shift 2;;
        --episode-id)
            if [ -n "${2}" ]
            then
                OPTIONS_ARRAY[episode-id]="${2}"
            fi
            shift 2;;
        --backup-id)
            if [ -n "${2}" ]
            then
                OPTIONS_ARRAY[backup-id]="${2}"
            fi
            shift 2;;
        --id)
            if [ -n "${2}" ]
            then
                OPTIONS_ARRAY[id]="${2}"
            fi
            shift 2;;
        --title)
            if [ -n "${2}" ]
            then
                OPTIONS_ARRAY[title]="${2}"
            fi
            shift 2;;
        --owner)
            if [ -n "${2}" ]
            then
                OPTIONS_ARRAY[owner]="${2}"
            fi
            shift 2;;
        --author)
            if [ -n "${2}" ]
            then
                OPTIONS_ARRAY[author]="${2}"
            fi
            shift 2;;
        --explicit)
            if [ -n "${2}" ]
            then
                OPTIONS_ARRAY[explicit]="${2}"
            fi
            shift 2;;
        --url)
            if [ -n "${2}" ]
            then
                OPTIONS_ARRAY[url]="${2}"
            fi
            shift 2;;
        --picture)
            if [ -n "${2}" ]
            then
                OPTIONS_ARRAY[picture]="${2}"
            fi
            shift 2;;
        --category)
            if [ -n "${2}" ]
            then
                OPTIONS_ARRAY[category]="${2}"
            fi
            shift 2;;
        --summary)
            if [ -n "${2}" ]
            then
                OPTIONS_ARRAY[summary]="${2}"
            fi
            shift 2;;
        --language)
            if [ -n "${2}" ]
            then
                OPTIONS_ARRAY[language]="${2}"
            fi
            shift 2;;
        --publication-datetime)
            if [ -n "${2}" ]
            then
                OPTIONS_ARRAY[publication-datetime]="${2}"
            fi
            shift 2;;
        --comment)
            if [ -n "${2}" ]
            then
                OPTIONS_ARRAY[comment]="${2}"
            fi
            shift 2;;
        --restore)
            if [ -n "${2}" ]
            then
                OPTIONS_ARRAY[restore]='true'
            fi
            shift 2;;
        --format)
            if [ -n "${2}" ]
            then
                OPTIONS_ARRAY[format]="${2}"
            fi
            shift 2;;
        --output)
            if [ -n "${2}" ]
            then
                OPTIONS_ARRAY[output]="${2}"
            fi
            shift 2;;
        --)
            shift
            break;;
    esac
done

# Create 'command'
command=""
if [ "${OPTIONS_ARRAY[help]}" == "true" ]; then command+="help"; fi
if [ "${OPTIONS_ARRAY[categories]}" == "true" ]; then command+=".categories"; fi
if [ "${OPTIONS_ARRAY[languages]}" == "true" ]; then command+=".languages"; fi
if [ "${OPTIONS_ARRAY[show]}" == "true" ]; then command+="show"; fi
if [ "${OPTIONS_ARRAY[episode]}" == "true" ]; then command+="episode"; fi
if [ "${OPTIONS_ARRAY[backup]}" == "true" ]; then command+="backup"; fi
if [ "${OPTIONS_ARRAY[feed]}" == "true" ]; then command+="feed"; fi
if [ "${OPTIONS_ARRAY[new]}" == "true" ]; then command+=".new"; fi
if [ "${OPTIONS_ARRAY[edit]}" == "true" ]; then command+=".edit"; fi
if [ "${OPTIONS_ARRAY[delete]}" == "true" ]; then command+=".delete"; fi
if [ "${OPTIONS_ARRAY[list]}" == "true" ]; then command+=".list"; fi
if [ "${OPTIONS_ARRAY[restore]}" == "true" ]; then command+=".restore"; fi

# echo "command: ${command}"

case "${command}" in
    "help")
        _print_usage
        exit 0;
    ;;
    "help.categories")
        echo "List of show categories"
        sqlite3 "${PATH_LOCAL_STORAGE}/databases/system/categories.db" -cmd ".mode column" -cmd ".headers on" -cmd ".width 4 40" "SELECT id AS code, name AS category FROM categories"
        exit 0;
    ;;
    "help.languages")
        echo "List of show languages"
        sqlite3 "${PATH_LOCAL_STORAGE}/databases/system/languages.db" -cmd ".mode column" -cmd ".headers on" -cmd ".width 4 40" "SELECT id AS code, name_english AS language FROM languages"
        exit 0;
    ;;
    "show.new")
        is_error="false"
        if [ "${is_error}" == "false" ]
        then
            declare -a MANDATORY_SHOW_NEW_INDEX_ARRAY=( "id" "title" "owner" "author" "url" "picture" "category" "summary" "language")
            for index in "${MANDATORY_SHOW_NEW_INDEX_ARRAY[@]}"
            do
                if [ -z "${OPTIONS_ARRAY[${index}]}" ] || [ "${OPTIONS_ARRAY[${index}]}" == "" ]
                then
                    echo "${index} is empty"
                    is_error="true"
                fi
            done
        fi

        # Validate 'id'
        if [ "${is_error}" == "false" ]
        then
            if [ "$(_is_id_valid "${OPTIONS_ARRAY[id]}")" == "false" ]
            then
                echo "[ERROR] ID is invalid. Accepted ID contains A-Z, a-z, 0-9, -,_ or . (no whitespaces)."
                is_error="true"
            else
                if [ $(sqlite3 "${PATH_LOCAL_STORAGE}/databases/system/shows.db" "SELECT EXISTS(SELECT 1 FROM shows WHERE local_id='${OPTIONS_ARRAY[id]}' LIMIT 1)") ]
                then
                    echo "[ERROR] A show with this ID already exist. Choose a different ID."
                    is_error="true"
                fi
            fi
        fi

        if [ "${is_error}" == "false" ]
        then
            declare -a URL_SHOW_NEW_INDEX_ARRAY=( "url" "picture" )
            for index in "${URL_SHOW_NEW_INDEX_ARRAY[@]}"
            do
                if [ "$(_is_url_valid "${OPTIONS_ARRAY[${index}]}")" == "false" ]
                then
                    echo "${index} is not valid"
                    is_error="true"
                fi
            done
        fi

        if [ "${is_error}" == "false" ]
        then
            if [ "$(_is_email_address_valid "${OPTIONS_ARRAY[owner]}")" == "false" ]
            then
                echo "Owner email address is NOT valid"
                is_error="true"
            fi
        fi

        if [ "${is_error}" == "false" ]
        then
            if [ -z "${OPTIONS_ARRAY[explicit]}" ] || [ "${OPTIONS_ARRAY[explicit]}" == "" ] || [ "${OPTIONS_ARRAY[explicit]}" == "true" ]
            then
                echo "is explicit"
                OPTIONS_ARRAY[explicit]="true"
            else
                if [ "${OPTIONS_ARRAY[explicit]}" == "false" ]
                then
                    echo "is NOT explicit"
                    OPTIONS_ARRAY[explicit]="false"
                else
                    echo "Explicit value is NOT valid."
                    is_error="true"
                fi
            fi
        fi

        if [ "${is_error}" == "false" ]
        then
            if [ ! $(sqlite3 "${PATH_LOCAL_STORAGE}/databases/system/categories.db" "SELECT EXISTS(SELECT 1 FROM categories WHERE id='${OPTIONS_ARRAY[category]}' LIMIT 1)") ]
            then
                is_error="true"
            fi
        fi

        if [ "${is_error}" == "false" ]
        then
            if [ ! $(sqlite3 "${PATH_LOCAL_STORAGE}/databases/system/languages.db" "SELECT EXISTS(SELECT 1 FROM languages WHERE id='${OPTIONS_ARRAY[language]}' LIMIT 1)") ]
            then
                is_error="true"
            fi
        fi

        if [ "${is_error}" == "true" ]
        then
            echo "[ERROR] Empty or invalid options."
            exit 1;
        fi

        # SHOW_NEW_INDEX_ARRAY=( "id" "title" "owner" "author" "url" "picture" "category" "summary" "language" "explicit")
        # columns=""
        # values=""
        # i=0
        # for index in "${SHOW_NEW_INDEX_ARRAY[@]}"
        # do
        #     if [ ${i} -eq 0 ]
        #     then
        #         columns="${index}"
        #         values="'${OPTIONS_ARRAY[${index}]}'"
        #     else
        #         columns+=",${index}"
        #         values+=",'${OPTIONS_ARRAY[${index}]}'"
        #     fi
        #     i=((i+1))
        # done

        # _database_insert "${PATH_LOCAL_STORAGE}/databases/shows/shows.db" "show" "id,title,owner,author," "'${id}','${title}','${owner}','${author}'"

        # if [ $? -ne 0 ]
        # then
        #     echo "[ERROR] Command failed."
        #     exit 1
        # fi
        ;;
    "show.edit")
        is_show="true"
        ;;
    "show.delete")
        is_show="true"
        ;;
    "show.list")
        is_show="true"
        ;;
    "episode.new")
        is_episode="true"
        ;;
    "episode.edit")
        is_new="true"
        ;;
    "episode.delete")
        is_edit="true"
        ;;
    "episode.list")
        is_edit="true"
        ;;
    "backup.new")
        is_show="true"
        ;;
    "backup.delete")
        is_show="true"
        ;;
    "backup.list")
        is_show="true"
        ;;
    "backup.restore")
        is_show="true"
        ;;
    "feed")
        is_show="true"
        ;;
    *)
        echo "[ERROR] Unknown command."
        _print_usage
        exit 1
        ;;
esac